#!/bin/bash

if [[ -f "$1.srt" ]]; then
    echo "Warning: output file $1.srt already exists" >&2
    exit 0
fi

if [[ -f "$1.txt" ]]; then
    echo "Warning: output file $1.txt already exists" >&2
    exit 0
fi
transcribe_file=$1
shift

ffmpeg -i "$transcribe_file" -af "silenceremove=start_periods=1:start_duration=0:start_threshold=-50dB: stop_periods=-1:stop_duration=0.02:stop_threshold=-50dB, apad=pad_dur=0.02" -ar 16000 -ac 1 -c:a pcm_s16le "$transcribe_file.wav"

# whisper --max-context 30 -tr -l ja -osrt -m models/ggml-large-v3.bin -f "$transcribe_file.wav" -of "$transcribe_file"
# whisper.cpp --max-context 10 -l auto -osrt -m models/ggml-large-v3.bin -f "$transcribe_file.wav" -of "$transcribe_file" | tee "$transcribe_file.txt"

# --condition-on-previous-text False (to avoid death loops)
mlx_whisper --model mlx-community/whisper-large-v3-turbo  "$transcribe_file.wav" --output-name "$transcribe_file" --output-format=srt --hallucination-silence-threshold 5 "$@"

rm -vf "$transcribe_file.wav"
