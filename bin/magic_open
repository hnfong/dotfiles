#!/bin/bash

# A script to open files in EDITOR([n]vim) with a little bit of magic.
#
# Features:
# - Open files normally if they exist
# - Parses line numbers in the format of <file>:<line_number>
# - Tries to find the file in the current git repo
# - Tries to find files that match a wildcard pattern if there is no exact match
# - Automatically open files in split windows if there less than 4 files
# - Automatically open files in tabs if there are more than 4 files
#

EDITOR=nvim

function magic_list_files() {
    # later optimization: we can probably avoid running magic_list_files too
    # many times (which is expensive) by saving the output in another temp
    # file.

    # check whether it is a git repo
    pushd . > /dev/null 2>/dev/null
    while [[ ! -d .git && "$PWD" != "/" ]]; do
        cd ..
    done
    local final_pwd=$PWD
    popd > /dev/null 2>/dev/null
    if [[ "$final_pwd" != "/" ]]; then
        git ls-tree -r --name-only HEAD -- . | head -n 500
    else
        find . -type f -maxdepth 2 -size -30M | head -n 500
    fi
}

function front_stripper() {
    local file_path;
    while read file_path; do
        while [[ -n "$file_path" && ! -e "$file_path" ]]; do
            local new_file_path=${file_path#*/}
            if [[ "$file_path" = "$new_file_path" ]]; then
                break;
            fi
            file_path=$new_file_path
        done
        echo $file_path
    done
}

function editor() {
    if [[ -n "$1" ]]; then
        cmd=$(basename $1)
        cmd=${cmd:0:15}
        if which tmux; then
            tmux rename-window "$cmd"
        fi
    fi
    if [[ -z "$my_line" ]]; then
        if [[ -z "$@" ]]; then
            exec "$EDITOR" -c ':Telescope oldfiles'
        else
            # Check the number of arguments, n
            if [[ "$#" -gt 4 ]]; then
                # If n > 5, open in tabs
                exec "$EDITOR" -p -c 'nmap <RIGHT> gt|nmap <LEFT> gT' "$@"
            else
                exec "$EDITOR" -O "$@"
            fi
            exec "$EDITOR" -O "$@"
        fi
    else
        exec "$EDITOR" $my_line -O "$@"
    fi
}


if [[ "$1" = "--test" ]]; then
    shift
    IS_MAGIC_OPEN_TEST=1
    EDITOR=echo
fi

# Preserve $@ for later use
original_args=("$@")

if [[ "$IS_MAGIC_OPEN_TEST" = "1" && -z "$1" ]]; then
    # Run tests
    cd "$(dirname "$0")"
    cd ../magic_open_test_environment/
    echo "Running tests in $(pwd)"
    # Ensure we have the appropriate files in the test environment
    touch a b c t
    touch x.txt y.txt z.txt
    mkdir -p d
    touch d/e d/f d/ggtxt
    touch d/e.txt d/f.txt

    # Test cases
    set -ex
    ../bin/magic_open --test x.txt | diff - <(echo "-O x.txt")
    ../bin/magic_open --test x.txt y.txt | diff - <(echo "-O x.txt y.txt")
    ../bin/magic_open --test x.txt:10 | diff - <(echo "+10 -O x.txt")
    ../bin/magic_open --test x. | diff - <(echo "-O x.txt")
    ../bin/magic_open --test .txt | diff - <(echo "-p -c nmap <RIGHT> gt|nmap <LEFT> gT d/e.txt d/f.txt x.txt y.txt z.txt")
    ../bin/magic_open --test e | diff - <(echo "-O d/e")
    ../bin/magic_open --test t | diff - <(echo "-O t")

    ../bin/magic_open --test asdflkajdflakjfdl | diff - <(echo "-O asdflkajdflakjfdl")
    ../bin/magic_open --test aa bb cc dd ee ff gg | diff - <(echo "-p -c nmap <RIGHT> gt|nmap <LEFT> gT aa bb cc dd ee ff d/ggtxt") # The quotes are gone. Thanks, UNIX.
    exit 0
fi

# Case: no arguments, just open as normal without arguments
if [[ -z "$1" ]]; then
    editor
fi

# vi -g '<git grep pattern>'
if [[ "$1" = "-g" ]]; then
    shift
    editor `git grep -l "$1"`
fi
#
# vi -r '<git ls-tree -r>'
if [[ "$1" = "-r" ]]; then
    shift
    editor `git ls-tree -r --name-only HEAD -- . | grep "$1"`
fi

PROCESSED_ARGS=()
for arg in "$@"; do
    if [[ -z "$my_line" && "$arg" =~ :[0-9][0-9]*$ ]]; then  # We can only focus on one line number, apparently
        splitter=(${arg//:/ })
        my_path=${splitter[0]}
        my_line=+${splitter[1]}
        arg="$my_path"
    fi

    if [[ ! -e "$arg" && -n "$arg" ]]; then
        found=0
        magic_open_temp_file=$(mktemp)

        # We store this in a temp file because this seems to be the only way to
        # avoid the while loop from running in a subshell
        magic_list_files | grep -F "$arg" | grep "[/^]$arg\$" | head -n 99 | front_stripper > "$magic_open_temp_file"
        # Check whether the temp file has any contents
        if [[ ! -s "$magic_open_temp_file" ]]; then
            magic_list_files | grep -F "$arg" | head -n 99 | front_stripper > "$magic_open_temp_file"
        fi
        while read -r file_path; do
            PROCESSED_ARGS+=("$file_path")
            found=1
        done < "$magic_open_temp_file"
        /bin/rm -f "$magic_open_temp_file"  # Use /bin/rm to avoid any aliases

        if [[ "$found" = "1" ]]; then
            arg=""
        fi
    fi

    if [[ -n "$arg" ]]; then
        arg=`echo "$arg" | front_stripper`

        PROCESSED_ARGS+=("$arg")
    fi
done

editor "${PROCESSED_ARGS[@]}"
